<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XAI 기반 금융 사기 탐지 시스템 - 결과 대시보드</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .nav-bar {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 15px 0;
        margin-bottom: 30px;
        border-radius: 15px;
      }

      .nav-bar .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-bar a {
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 25px;
        transition: all 0.3s ease;
      }

      .nav-bar a:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .nav-bar a.active {
        background: rgba(255, 255, 255, 0.3);
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        color: white;
      }

      .header h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
        font-weight: 300;
      }

      /* 모델 정보 섹션 스타일 */
      .model-info {
        margin-bottom: 30px;
      }

      .model-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        margin: 0 auto;
        max-width: 800px;
      }

      .model-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 15px;
      }

      .model-header i {
        font-size: 2rem;
        color: #fbbf24;
      }

      .model-header h3 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        flex: 1;
      }

      .model-toggle-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .model-toggle-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
      }

      .model-toggle-btn i {
        transition: transform 0.3s ease;
      }

      .model-toggle-btn.expanded i {
        transform: rotate(180deg);
      }

      .model-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .model-param {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        backdrop-filter: blur(10px);
      }

      .param-label {
        font-weight: 600;
        color: #e2e8f0;
      }

      .param-value {
        font-weight: 500;
        color: #fbbf24;
        text-align: right;
        max-width: 200px;
      }

      .model-advantage {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        backdrop-filter: blur(10px);
      }

      .model-advantage p {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      @media (max-width: 768px) {
        .model-details {
          grid-template-columns: 1fr;
        }

        .model-param {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .param-value {
          text-align: left;
          max-width: none;
        }
      }

      /* 실시간 예측 폼 스타일 */
      .prediction-form {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .prediction-form h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #4a5568;
      }

      .form-group input,
      .form-group select {
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .predict-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .predict-btn:hover {
        transform: translateY(-2px);
      }

      .prediction-result {
        background: #f7fafc;
        padding: 20px;
        border-radius: 15px;
        margin-top: 20px;
        border-left: 5px solid #667eea;
        display: none;
      }

      .prediction-result.show {
        display: block;
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .risk-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
      }

      .risk-low {
        background: #c6f6d5;
        color: #22543d;
      }

      .risk-medium {
        background: #fef5e7;
        color: #744210;
      }

      .risk-high {
        background: #fed7d7;
        color: #742a2a;
      }

      /* AML 규제 알림 스타일 */
      .aml-updates {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .aml-updates h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .update-item {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .update-item:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
      }

      .update-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .update-title {
        font-weight: 600;
        color: #2d3748;
        font-size: 16px;
        flex: 1;
      }

      .update-date {
        color: #718096;
        font-size: 14px;
        white-space: nowrap;
        margin-left: 15px;
      }

      .update-summary {
        color: #4a5568;
        margin-bottom: 10px;
        line-height: 1.5;
      }

      .update-impact {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .impact-high {
        background: #fed7d7;
        color: #742a2a;
      }

      .impact-medium {
        background: #fef5e7;
        color: #744210;
      }

      .impact-low {
        background: #c6f6d5;
        color: #22543d;
      }

      .update-deadline {
        color: #e53e3e;
        font-weight: 600;
        font-size: 14px;
      }

      /* 모달 스타일 */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 2% auto;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
        position: relative;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 20px 20px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }

      .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.3s ease;
      }

      .close:hover {
        opacity: 0.7;
      }

      .modal-body {
        padding: 30px;
      }

      /* 모달 스크롤바 스타일 */
      .modal-content::-webkit-scrollbar {
        width: 8px;
      }

      .modal-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .modal-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .modal-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      .transaction-overview {
        margin-bottom: 25px;
        padding: 20px;
        background: #f7fafc;
        border-radius: 15px;
      }

      .risk-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .fraud-probability {
        font-size: 1.1rem;
        color: #2d3748;
      }

      .feature-impact-section {
        margin-bottom: 25px;
      }

      .feature-impact-section h3 {
        color: #2d3748;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .feature-impact-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .feature-name {
        font-weight: 600;
        color: #2d3748;
      }

      .feature-impact {
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .impact-positive {
        background: #fed7d7;
        color: #742a2a;
      }

      .impact-negative {
        background: #c6f6d5;
        color: #22543d;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn-primary,
      .btn-secondary {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
      }

      .btn-secondary:hover {
        background: #cbd5e0;
        transform: translateY(-2px);
      }

      /* 정상거래 변경 섹션 스타일 */
      .override-section {
        margin-top: 30px;
        padding: 25px;
        background: #f8fafc;
        border-radius: 15px;
        border: 2px dashed #cbd5e0;
      }

      .override-section h3 {
        color: #2d3748;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.3rem;
      }

      .override-form {
        margin-top: 20px;
      }

      .override-form .form-group {
        margin-bottom: 20px;
      }

      .override-form label {
        display: block;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 8px;
      }

      .override-form textarea,
      .override-form input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        font-family: inherit;
      }

      .override-form textarea:focus,
      .override-form input:focus {
        outline: none;
        border-color: #48bb78;
        box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
      }

      .btn-override {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 auto;
      }

      .btn-override:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
      }

      .btn-override:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* SHAP 분석 섹션 스타일 */
      .shap-analysis-section {
        margin-top: 25px;
        padding: 25px;
        background: #f8fafc;
        border-radius: 15px;
        border: 1px solid #e2e8f0;
      }

      .shap-analysis-section h3 {
        color: #2d3748;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.3rem;
      }

      .shap-chart-container {
        text-align: center;
        margin-bottom: 25px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .shap-chart-container img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .llm-explanation {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .llm-explanation h4 {
        color: #2d3748;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
      }

      .llm-explanation-content {
        color: #4a5568;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .llm-explanation-content p {
        margin-bottom: 12px;
      }

      .llm-explanation-content ul {
        margin: 15px 0;
        padding-left: 20px;
      }

      .llm-explanation-content li {
        margin-bottom: 8px;
      }

      .llm-explanation-content .highlight {
        background: #fff3cd;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
      }

      /* 더보기 버튼 스타일 */
      .view-more-section {
        text-align: center;
        margin-top: 20px;
      }

      .view-more-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .view-more-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      .stat-card i {
        font-size: 2.5rem;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .stat-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        color: #2d3748;
      }

      .stat-card p {
        color: #718096;
        font-weight: 500;
      }

      .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
      }

      .chart-section {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .chart-section h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
      }

      .feature-importance {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .feature-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #e2e8f0;
      }

      .feature-item:last-child {
        border-bottom: none;
      }

      .feature-name {
        font-weight: 500;
        color: #2d3748;
      }

      .feature-value {
        font-weight: 700;
        color: #667eea;
        font-size: 1.1rem;
      }

      .feature-more-section {
        text-align: center;
        margin-top: 20px;
      }

      .feature-more-section button {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .feature-more-section button:hover {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      .feature-more-section button.expanded {
        background: #e53e3e;
      }

      .feature-more-section button.expanded:hover {
        background: #c53030;
      }

      .shap-analysis {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .transaction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .transaction-card {
        background: #f7fafc;
        padding: 20px;
        border-radius: 15px;
        border-left: 4px solid #667eea;
      }

      .transaction-card h4 {
        color: #2d3748;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .transaction-details {
        font-size: 0.9rem;
        color: #718096;
      }

      .footer {
        text-align: center;
        color: white;
        opacity: 0.8;
        margin-top: 40px;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
      }

      .metric-highlight {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
      }

      .metric-highlight h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }

      .metric-highlight p {
        opacity: 0.9;
      }

      /* 실시간 위험도 모니터링 스타일 */
      .monitoring-section {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .monitoring-section h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .monitoring-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .monitoring-card {
        padding: 20px;
        border-radius: 15px;
        border-left: 4px solid;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
      }

      .monitoring-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .monitoring-card.critical-risk {
        background: linear-gradient(135deg, #fff5f5, #fed7d7);
        border-left-color: #c53030;
      }

      .monitoring-card.high-risk {
        background: linear-gradient(135deg, #fff5f5, #feb2b2);
        border-left-color: #e53e3e;
      }

      .monitoring-card.medium-risk {
        background: linear-gradient(135deg, #fffbeb, #fef5e7);
        border-left-color: #ed8936;
      }

      .risk-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .risk-header i {
        font-size: 1.2rem;
      }

      .risk-level {
        font-weight: 600;
        font-size: 0.9rem;
        padding: 4px 12px;
        border-radius: 20px;
        color: white;
      }

      .high-risk .risk-level {
        background: #e53e3e;
      }

      .medium-risk .risk-level {
        background: #ed8936;
      }

      .critical-risk .risk-level {
        background: #c53030;
      }

      .risk-content h4 {
        font-size: 1.1rem;
        margin-bottom: 8px;
        color: #2d3748;
      }

      .risk-score {
        font-weight: 600;
        color: #e53e3e;
        margin-bottom: 10px;
        font-size: 1rem;
      }

      .risk-details {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .risk-factor {
        background: rgba(0, 0, 0, 0.1);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        color: #4a5568;
      }

      .risk-time {
        font-size: 0.8rem;
        color: #718096;
        font-style: italic;
      }

      .monitoring-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px;
        background: #f7fafc;
        border-radius: 15px;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #4a5568;
        font-size: 0.9rem;
      }

      .stat-item i {
        color: #667eea;
        font-size: 1rem;
      }

      .stat-item strong {
        color: #2d3748;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="nav-bar">
        <div class="container">
          <a href="index.html" class="active"><i class="fas fa-home"></i> 홈</a>
          <a href="analysis.html"><i class="fas fa-chart-bar"></i> 상세 분석</a>
          <a href="reports.html"><i class="fas fa-file-alt"></i> 보고서 생성</a>
          <a href="#"><i class="fas fa-cog"></i> 설정</a>
        </div>
      </div>

      <div class="header">
        <h1><i class="fas fa-shield-alt"></i> XAI 금융 사기 탐지 시스템</h1>
        <p>설명 가능한 AI를 활용한 지능형 사기 탐지 및 자동 보고서 생성</p>
      </div>

      <!-- 모델 정보 섹션 -->
      <div class="model-info">
        <div class="model-card">
          <div class="model-header">
            <i class="fas fa-brain"></i>
            <h3>사용 모델: LightGBM (LGBMClassifier)</h3>
            <button class="model-toggle-btn" onclick="toggleModelDetails()">
              <i class="fas fa-chevron-down"></i> 상세 정보 보기
            </button>
          </div>
          <div class="model-details" id="modelDetails" style="display: none">
            <div class="model-param">
              <span class="param-label">알고리즘:</span>
              <span class="param-value">Gradient Boosting Decision Trees</span>
            </div>
            <div class="model-param">
              <span class="param-label">트리 개수:</span>
              <span class="param-value">200개</span>
            </div>
            <div class="model-param">
              <span class="param-label">학습률:</span>
              <span class="param-value">0.1</span>
            </div>
            <div class="model-param">
              <span class="param-label">최대 깊이:</span>
              <span class="param-value">무제한 (과적합 방지)</span>
            </div>
            <div class="model-param">
              <span class="param-label">특징:</span>
              <span class="param-value"
                >빠른 학습, 메모리 효율적, 범주형 변수 자동 처리</span
              >
            </div>
            <div class="model-advantage">
              <p>
                <strong>LightGBM 선택 이유:</strong> 금융 사기 탐지에 최적화된
                성능과 빠른 실시간 예측 속도
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <i class="fas fa-search"></i>
          <h3>86.7%</h3>
          <p>사기 탐지 정밀도 (Precision)</p>
        </div>
        <div class="stat-card">
          <i class="fas fa-search"></i>
          <h3>95.1%</h3>
          <p>사기 탐지 재현율 (Recall)</p>
        </div>
        <div class="stat-card">
          <i class="fas fa-balance-scale"></i>
          <h3>90.7%</h3>
          <p>사기 탐지 F1-Score</p>
        </div>
        <div class="stat-card">
          <i class="fas fa-percentage"></i>
          <h3>74.2%</h3>
          <p>AUPRC</p>
        </div>
      </div>

      <div class="metric-highlight">
        <h3>모델 성능 요약</h3>
        <p>
          PaySim 전체 데이터(636만 건) 중 127만 건으로 실험하여
          <strong>사기 탐지 F1-Score 90.7%</strong>로 높은 성능 달성. 정밀도
          86.7%, 재현율 95.1%로 균형잡힌 사기 탐지 성능
        </p>
      </div>

      <div class="main-content">
        <div class="chart-section">
          <h2><i class="fas fa-chart-pie"></i> 모델 예측 결과 분석</h2>
          <div class="chart-container">
            <canvas id="confusionMatrix"></canvas>
          </div>
          <div style="text-align: center; color: #718096; font-size: 0.9rem">
            <p>
              <strong>정확한 예측:</strong> 정상 거래 1,267,648건, 사기 거래
              4,047건
            </p>
            <p>
              <strong>잘못된 예측:</strong> 정상을 사기로 잘못 분류 622건,
              사기를 놓침 207건
            </p>
          </div>
        </div>

        <div class="feature-importance">
          <h2><i class="fas fa-list-ol"></i> SHAP 피처 중요도</h2>
          <div id="featureList">
            <!-- 동적으로 생성되는 피처 목록 -->
          </div>
          <div class="feature-more-section">
            <button
              id="showMoreFeatures"
              class="btn-secondary"
              onclick="toggleFeatureList()"
            >
              <i class="fas fa-chevron-down"></i> 더보기
            </button>
          </div>
          <div
            style="
              margin-top: 20px;
              padding: 15px;
              background: #f7fafc;
              border-radius: 10px;
            "
          >
            <p style="font-size: 0.9rem; color: #718096; text-align: center">
              <strong>해석:</strong> 현금 입금 유형과 잔액 대비 거래 금액 비율이
              사기 탐지에 가장 중요한 요소
            </p>
          </div>
        </div>
      </div>

      <!-- AML 규제 업데이트 알림 -->
      <div class="aml-updates">
        <h2>
          <i class="fas fa-exclamation-triangle"></i> AML 규제 업데이트 실시간
          알림
        </h2>
        <div id="amlUpdatesList">
          <!-- 동적으로 업데이트됨 -->
        </div>
      </div>

      <!-- 거래 상세 정보 모달 -->
      <div id="transactionModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="modalTitle">거래 상세 정보</h2>
            <span class="close" onclick="closeTransactionModal()">&times;</span>
          </div>
          <div class="modal-body">
            <div class="transaction-overview">
              <div class="risk-summary">
                <span class="risk-badge" id="modalRiskBadge"></span>
                <div class="fraud-probability">
                  <strong>사기 확률:</strong>
                  <span id="modalFraudProbability"></span>
                </div>
              </div>
            </div>

            <div class="feature-impact-section">
              <h3><i class="fas fa-chart-line"></i> 주요 영향 피처 분석</h3>
              <div id="modalFeatureImpacts">
                <!-- 동적으로 생성됨 -->
              </div>
            </div>

            <div class="action-buttons">
              <button class="btn-primary" onclick="toggleSHAPAnalysis()">
                <i class="fas fa-microscope"></i> 상세 SHAP 분석 보기
              </button>
              <button class="btn-secondary" onclick="generateReport()">
                <i class="fas fa-file-alt"></i> 보고서 생성
              </button>
            </div>

            <!-- SHAP 분석 섹션 (숨겨짐) -->
            <div
              id="shapAnalysisSection"
              class="shap-analysis-section"
              style="display: none"
            >
              <h3><i class="fas fa-chart-line"></i> SHAP Waterfall Plot</h3>
              <div class="shap-chart-container">
                <img id="shapChart" src="" alt="SHAP 분석 차트" />
              </div>

              <div class="llm-explanation">
                <h4><i class="fas fa-robot"></i> AI 결과 해석</h4>
                <div id="llmExplanation">
                  <!-- 동적으로 생성됨 -->
                </div>
              </div>
            </div>

            <!-- 정상거래 변경 섹션 -->
            <div class="override-section">
              <h3><i class="fas fa-undo"></i> AI 판단 재검토</h3>
              <p style="color: #718096; font-size: 0.9rem; margin-bottom: 15px">
                AI가 사기로 판단했지만, 실제로는 정상 거래일 수 있습니다. 정상
                거래로 변경하려면 아래 사유를 입력해주세요.
              </p>

              <div class="override-form">
                <div class="form-group">
                  <label for="overrideReason">정상거래 변경 사유</label>
                  <textarea
                    id="overrideReason"
                    placeholder="예: 고객이 직접 확인한 정상 거래, 특별한 상황으로 인한 거래 등"
                    rows="3"
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="reviewerName">검토자명</label>
                  <input
                    type="text"
                    id="reviewerName"
                    placeholder="검토자 이름을 입력하세요"
                  />
                </div>

                <button class="btn-override" onclick="overrideToNormal()">
                  <i class="fas fa-check-circle"></i> 정상거래로 변경
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 실시간 위험도 모니터링 섹션 추가 -->
      <div class="monitoring-section">
        <h2><i class="fas fa-radar"></i> 실시간 위험도 모니터링</h2>
        <p style="color: #718096; margin-bottom: 20px">
          현재 탐지된 위험 거래들의 실시간 모니터링
        </p>

        <div class="monitoring-grid">
          <div
            class="monitoring-card critical-risk"
            onclick="goToTransactionAnalysis('22133')"
          >
            <div class="risk-header">
              <i class="fas fa-skull-crossbones"></i>
              <span class="risk-level">매우높음</span>
            </div>
            <div class="risk-content">
              <h4>거래 #22133</h4>
              <div class="risk-score">위험도: 97.3%</div>
              <div class="risk-details">
                <span class="risk-factor">복합위험</span>
                <span class="risk-factor">자금세탁</span>
              </div>
              <div class="risk-time">탐지: 1분 전</div>
            </div>
          </div>

          <div
            class="monitoring-card high-risk"
            onclick="goToTransactionAnalysis('9770')"
          >
            <div class="risk-header">
              <i class="fas fa-exclamation-triangle"></i>
              <span class="risk-level">높음</span>
            </div>
            <div class="risk-content">
              <h4>거래 #9770</h4>
              <div class="risk-score">위험도: 95.2%</div>
              <div class="risk-details">
                <span class="risk-factor">현금입금</span>
                <span class="risk-factor">대규모거래</span>
              </div>
              <div class="risk-time">탐지: 2분 전</div>
            </div>
          </div>

          <div
            class="monitoring-card medium-risk"
            onclick="goToTransactionAnalysis('9771')"
          >
            <div class="risk-header">
              <i class="fas fa-exclamation-circle"></i>
              <span class="risk-level">보통</span>
            </div>
            <div class="risk-content">
              <h4>거래 #9771</h4>
              <div class="risk-score">위험도: 94.8%</div>
              <div class="risk-details">
                <span class="risk-factor">현금입금</span>
                <span class="risk-factor">잔액불일치</span>
              </div>
              <div class="risk-time">탐지: 5분 전</div>
            </div>
          </div>
        </div>

        <div class="monitoring-stats">
          <div class="stat-item">
            <i class="fas fa-clock"></i>
            <span>오늘 탐지된 위험 거래: <strong>12건</strong></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-shield-alt"></i>
            <span>차단된 사기 거래: <strong>8건</strong></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-chart-line"></i>
            <span>평균 응답 시간: <strong>0.3초</strong></span>
          </div>
        </div>

        <!-- 더보기 버튼 -->
        <div class="view-more-section">
          <button class="view-more-btn" onclick="showAllRiskyTransactions()">
            <i class="fas fa-external-link-alt"></i> 모든 위험 거래 보기
          </button>
        </div>
      </div>

      <div class="shap-analysis">
        <h2><i class="fas fa-microscope"></i> 개별 거래 SHAP 분석</h2>
        <p style="color: #718096; margin-bottom: 20px">
          주요 의심거래에 대한 모델의 판단 근거 분석
        </p>

        <div class="transaction-grid">
          <div class="transaction-card">
            <h4>거래 #9770 ✅</h4>
            <div class="transaction-details">
              <p><strong>예측:</strong> 사기</p>
              <p><strong>실제:</strong> 사기</p>
              <p><strong>주요 근거:</strong></p>
              <ul style="margin-left: 20px; margin-top: 5px">
                <li>type_CASH_IN: +39,461</li>
                <li>amount_to_balance_ratio: +30,624</li>
                <li>oldbalanceOrg: +21,934</li>
              </ul>
            </div>
          </div>

          <div class="transaction-card">
            <h4>거래 #9771 ✅</h4>
            <div class="transaction-details">
              <p><strong>예측:</strong> 사기</p>
              <p><strong>실제:</strong> 사기</p>
              <p><strong>주요 근거:</strong></p>
              <ul style="margin-left: 20px; margin-top: 5px">
                <li>type_CASH_IN: +39,464</li>
                <li>amount_to_balance_ratio: +30,702</li>
                <li>oldbalanceOrg: +18,160</li>
              </ul>
            </div>
          </div>

          <div class="transaction-card">
            <h4>거래 #22133 ✅</h4>
            <div class="transaction-details">
              <p><strong>예측:</strong> 사기</p>
              <p><strong>실제:</strong> 사기</p>
              <p><strong>주요 근거:</strong></p>
              <ul style="margin-left: 20px; margin-top: 5px">
                <li>type_CASH_IN: +68,413</li>
                <li>type_PAYMENT: +53,484</li>
                <li>oldbalanceOrg: -46,158</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- 실시간 예측 폼 -->
      <div class="prediction-form">
        <h2><i class="fas fa-robot"></i> 실시간 거래 위험도 예측</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="amount">거래 금액 (원)</label>
            <input
              type="number"
              id="amount"
              value="1000000"
              min="1000"
              max="100000000"
            />
          </div>
          <div class="form-group">
            <label for="hour">거래 시간 (24시간)</label>
            <input type="number" id="hour" value="14" min="0" max="23" />
          </div>
          <div class="form-group">
            <label for="merchant_category">거래 유형</label>
            <select id="merchant_category">
              <option value="1" selected>TRANSFER (송금)</option>
              <option value="2">CASH_IN (현금입금)</option>
              <option value="3">CASH_OUT (현금출금)</option>
              <option value="4">DEBIT (직불)</option>
              <option value="5">PAYMENT (결제)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="oldbalanceOrg">송금자 잔액 (원)</label>
            <input
              type="number"
              id="oldbalanceOrg"
              value="5000000"
              min="0"
              max="1000000000"
            />
          </div>
          <div class="form-group">
            <label for="oldbalanceDest">수신자 잔액 (원)</label>
            <input
              type="number"
              id="oldbalanceDest"
              value="1000000"
              min="0"
              max="1000000000"
            />
          </div>
          <div class="form-group">
            <label for="balance_zero_both">잔액 0 여부</label>
            <select id="balance_zero_both">
              <option value="0" selected>아니오</option>
              <option value="1">예 (둘 다 0)</option>
            </select>
          </div>
        </div>
        <button class="predict-btn" onclick="predictTransaction()">
          <i class="fas fa-search"></i> 위험도 예측하기
        </button>

        <div class="prediction-result" id="predictionResult">
          <div class="result-header">
            <h3>예측 결과</h3>
            <span class="risk-badge" id="riskBadge"></span>
          </div>
          <div id="predictionDetails"></div>
        </div>
      </div>

      <div class="footer">
        <p>© 2025 XAI 금융 사기 탐지 시스템 | 이예림</p>
      </div>
    </div>

    <script>
      // 페이지 로드 시 AML 업데이트 로드
      document.addEventListener("DOMContentLoaded", function () {
        loadAMLUpdates();
        initializeFeatureList();

        // 모달 외부 클릭 시 닫기
        window.addEventListener("click", function (event) {
          const modal = document.getElementById("transactionModal");
          if (event.target === modal) {
            closeTransactionModal();
          }
        });
      });

      // 실시간 거래 예측 함수
      async function predictTransaction() {
        const formData = {
          amount: parseFloat(document.getElementById("amount").value),
          hour: parseInt(document.getElementById("hour").value),
          oldbalanceOrg: parseFloat(
            document.getElementById("oldbalanceOrg").value
          ),
          oldbalanceDest: parseFloat(
            document.getElementById("oldbalanceDest").value
          ),
          balance_zero_both: parseInt(
            document.getElementById("balance_zero_both").value
          ),
          merchant_category: parseInt(
            document.getElementById("merchant_category").value
          ),
        };

        try {
          const response = await fetch("/api/predict", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (result.success) {
            displayPredictionResult(result);
          } else {
            alert("예측 중 오류가 발생했습니다: " + result.error);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("서버 연결 오류가 발생했습니다.");
        }
      }

      // 예측 결과 표시 함수
      function displayPredictionResult(result) {
        const resultDiv = document.getElementById("predictionResult");
        const riskBadge = document.getElementById("riskBadge");
        const detailsDiv = document.getElementById("predictionDetails");

        // 위험도 배지 설정
        riskBadge.textContent = result.risk_level;
        riskBadge.className = "risk-badge";

        if (result.risk_level === "낮음") {
          riskBadge.classList.add("risk-low");
        } else if (result.risk_level === "보통") {
          riskBadge.classList.add("risk-medium");
        } else {
          riskBadge.classList.add("risk-high");
        }

        // 상세 정보 표시
        detailsDiv.innerHTML = `
          <div style="margin-bottom: 15px;">
            <strong>사기 확률:</strong> ${(
              result.fraud_probability * 100
            ).toFixed(1)}%
          </div>
          <div style="margin-bottom: 15px;">
            <strong>거래 정보:</strong>
            <ul style="margin-left: 20px; margin-top: 5px;">
              <li>거래 금액: ${result.transaction_data.amount.toLocaleString()}원</li>
              <li>거래 시간: ${result.transaction_data.hour}시</li>
              <li>송금자 잔액: ${result.transaction_data.oldbalanceOrg.toLocaleString()}원</li>
              <li>수신자 잔액: ${result.transaction_data.oldbalanceDest.toLocaleString()}원</li>
            </ul>
          </div>
          <div style="color: #e53e3e; font-weight: 600;">
            <i class="fas fa-clock"></i> 예측 시간: ${new Date(
              result.timestamp
            ).toLocaleString()}
          </div>
        `;

        resultDiv.classList.add("show");
      }

      // AML 업데이트 로드 함수
      async function loadAMLUpdates() {
        try {
          const response = await fetch("/api/aml-updates");
          const data = await response.json();

          if (data.success) {
            displayAMLUpdates(data.updates);
          }
        } catch (error) {
          console.error("AML 업데이트 로드 오류:", error);
        }
      }

      // AML 업데이트 표시 함수
      function displayAMLUpdates(updates) {
        const container = document.getElementById("amlUpdatesList");

        container.innerHTML = updates
          .map(
            (update) => `
          <div class="update-item">
            <div class="update-header">
              <div class="update-title">${update.title}</div>
              <div class="update-date">${update.date}</div>
            </div>
            <div class="update-summary">${update.summary}</div>
            <span class="update-impact impact-${
              update.impact === "높음"
                ? "high"
                : update.impact === "중간"
                ? "medium"
                : "low"
            }">
              영향도: ${update.impact}
            </span>
            <div class="update-deadline">
              <i class="fas fa-calendar-times"></i> 준수 기한: ${
                update.deadline
              }
            </div>
          </div>
        `
          )
          .join("");
      }

      // 모든 위험 거래 보기 함수
      function showAllRiskyTransactions() {
        // 새 창에서 상세 분석 페이지 열기
        window.open("analysis.html", "_blank");
      }

      // 개별 거래 상세분석으로 이동 함수
      function goToTransactionAnalysis(transactionId) {
        // 모달에 거래 정보 표시
        showTransactionModal(transactionId);
      }

      // 거래 상세 정보 모달 표시 함수
      function showTransactionModal(transactionId) {
        const modal = document.getElementById("transactionModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalRiskBadge = document.getElementById("modalRiskBadge");
        const modalFraudProbability = document.getElementById(
          "modalFraudProbability"
        );
        const modalFeatureImpacts = document.getElementById(
          "modalFeatureImpacts"
        );

        // 거래별 정보 설정
        const transactionData = {
          22133: {
            title: "거래 #22133 상세 분석",
            riskLevel: "매우높음",
            fraudProbability: "97.3%",
            features: [
              {
                name: "type_CASH_IN",
                impact: "+68,413",
                description: "현금 입금 유형으로 인한 높은 위험도",
              },
              {
                name: "type_PAYMENT",
                impact: "+53,484",
                description: "결제 거래 패턴의 의심스러운 특성",
              },
              {
                name: "oldbalanceOrg",
                impact: "-46,158",
                description: "송금자 잔액의 급격한 감소",
              },
              {
                name: "amount_to_balance_ratio",
                impact: "+42,156",
                description: "잔액 대비 거래금액의 비정상적 비율",
              },
            ],
          },
          9770: {
            title: "거래 #9770 상세 분석",
            riskLevel: "높음",
            fraudProbability: "95.2%",
            features: [
              {
                name: "type_CASH_IN",
                impact: "+39,461",
                description: "현금 입금 유형의 높은 영향력",
              },
              {
                name: "amount_to_balance_ratio",
                impact: "+30,624",
                description: "잔액 대비 거래금액의 비정상적 비율",
              },
              {
                name: "oldbalanceOrg",
                impact: "+21,934",
                description: "송금자 잔액의 급격한 변화",
              },
              {
                name: "hour",
                impact: "+14,000",
                description: "거래 시간대의 의심스러운 패턴",
              },
            ],
          },
          9771: {
            title: "거래 #9771 상세 분석",
            riskLevel: "보통",
            fraudProbability: "94.8%",
            features: [
              {
                name: "type_CASH_IN",
                impact: "+39,464",
                description: "현금 입금 유형의 영향력",
              },
              {
                name: "amount_to_balance_ratio",
                impact: "+30,702",
                description: "잔액 대비 거래금액의 비정상적 비율",
              },
              {
                name: "oldbalanceOrg",
                impact: "+18,160",
                description: "송금자 잔액의 변화",
              },
              {
                name: "hour",
                impact: "+12,000",
                description: "거래 시간대의 패턴",
              },
            ],
          },
        };

        const data = transactionData[transactionId];
        if (data) {
          modalTitle.textContent = data.title;
          modalRiskBadge.textContent = data.riskLevel;
          modalRiskBadge.className = "risk-badge";

          if (data.riskLevel === "매우높음") {
            modalRiskBadge.classList.add("risk-high");
          } else if (data.riskLevel === "높음") {
            modalRiskBadge.classList.add("risk-high");
          } else {
            modalRiskBadge.classList.add("risk-medium");
          }

          modalFraudProbability.textContent = data.fraudProbability;

          // 피처 영향력 표시
          modalFeatureImpacts.innerHTML = data.features
            .map(
              (feature) => `
            <div class="feature-impact-item">
              <div>
                <div class="feature-name">${feature.name}</div>
                <div style="font-size: 0.9rem; color: #718096; margin-top: 5px;">
                  ${feature.description}
                </div>
              </div>
              <span class="feature-impact impact-positive">${feature.impact}</span>
            </div>
          `
            )
            .join("");

          modal.style.display = "block";

          // 모달을 맨 위로 스크롤
          modal.scrollTop = 0;

          // SHAP 분석 섹션 숨기기 및 초기화
          const shapSection = document.getElementById("shapAnalysisSection");
          shapSection.style.display = "none";

          // LLM 설명 내용도 초기화
          const llmExplanation = document.getElementById("llmExplanation");
          if (llmExplanation) {
            llmExplanation.innerHTML = "";
          }

          // 버튼 초기화
          const button = document.querySelector(".btn-primary");
          button.innerHTML =
            '<i class="fas fa-microscope"></i> 상세 SHAP 분석 보기';
          button.classList.remove("btn-secondary");
          button.classList.add("btn-primary");

          // 폼 초기화
          document.getElementById("overrideReason").value = "";
          document.getElementById("reviewerName").value = "";

          // 정상거래 변경 섹션 초기화
          const overrideSection = document.querySelector(".override-section");
          if (overrideSection) {
            overrideSection.innerHTML = `
              <h3><i class="fas fa-undo"></i> AI 판단 재검토</h3>
              <p style="color: #718096; font-size: 0.9rem; margin-bottom: 15px;">
                AI가 사기로 판단했지만, 실제로는 정상 거래일 수 있습니다. 
                정상 거래로 변경하려면 아래 사유를 입력해주세요.
              </p>
              
              <div class="override-form">
                <div class="form-group">
                  <label for="overrideReason">정상거래 변경 사유</label>
                  <textarea 
                    id="overrideReason" 
                    placeholder="예: 고객이 직접 확인한 정상 거래, 특별한 상황으로 인한 거래 등"
                    rows="3"
                  ></textarea>
                </div>
                
                <div class="form-group">
                  <label for="reviewerName">검토자명</label>
                  <input 
                    type="text" 
                    id="reviewerName" 
                    placeholder="검토자 이름을 입력하세요"
                  />
                </div>
                
                <button class="btn-override" onclick="overrideToNormal()">
                  <i class="fas fa-check-circle"></i> 정상거래로 변경
                </button>
              </div>
            `;
          }
        }
      }

      // 모달 닫기 함수
      function closeTransactionModal() {
        document.getElementById("transactionModal").style.display = "none";
      }

      // SHAP 분석 토글 함수
      function toggleSHAPAnalysis() {
        const shapSection = document.getElementById("shapAnalysisSection");
        const button = document.querySelector(".btn-primary");

        if (shapSection.style.display === "none") {
          // SHAP 분석 표시
          shapSection.style.display = "block";
          button.innerHTML =
            '<i class="fas fa-eye-slash"></i> SHAP 분석 숨기기';
          button.classList.add("btn-secondary");
          button.classList.remove("btn-primary");

          // SHAP 차트와 LLM 설명 로드
          loadSHAPAnalysis();
        } else {
          // SHAP 분석 숨기기
          shapSection.style.display = "none";
          button.innerHTML =
            '<i class="fas fa-microscope"></i> 상세 SHAP 분석 보기';
          button.classList.remove("btn-secondary");
          button.classList.add("btn-primary");

          // SHAP 분석 섹션을 완전히 숨기고 초기 상태로 복원
          const llmExplanation = document.getElementById("llmExplanation");
          if (llmExplanation) {
            llmExplanation.innerHTML = "";
          }
        }
      }

      // SHAP 분석 로드 함수
      function loadSHAPAnalysis() {
        const currentTransactionId = getCurrentTransactionId();
        const shapChart = document.getElementById("shapChart");
        const llmExplanation = document.getElementById("llmExplanation");

        // SHAP 차트 이미지 설정
        shapChart.src = `images/individual_shap_transaction_${currentTransactionId}.png`;

        // LLM 설명 생성
        generateLLMExplanation(currentTransactionId);
      }

      // 현재 거래 ID 가져오기
      function getCurrentTransactionId() {
        // 모달 제목에서 거래 ID 추출
        const title = document.getElementById("modalTitle").textContent;
        const match = title.match(/거래 #(\d+)/);
        return match ? match[1] : "22133";
      }

      // LLM 설명 생성 함수
      function generateLLMExplanation(transactionId) {
        const llmExplanation = document.getElementById("llmExplanation");

        const explanations = {
          22133: {
            summary:
              '이 거래는 <span class="highlight">복합적인 위험 요소</span>가 결합되어 AI가 사기로 판단했습니다.',
            keyFactors: [
              "현금 입금 유형(type_CASH_IN)이 가장 큰 영향을 미쳤으며, 이는 일반적으로 사기 거래에서 자주 나타나는 패턴입니다.",
              "결제 거래 패턴(type_PAYMENT)도 의심스러운 특성을 보여 추가적인 위험 신호를 제공했습니다.",
              "송금자 잔액의 급격한 감소(-46,158)는 자금 세탁이나 사기 조직의 활동을 시사합니다.",
              "잔액 대비 거래금액의 비정상적 비율(+42,156)은 일반적인 거래 패턴과 크게 벗어납니다.",
            ],
            recommendation:
              "이 거래는 즉시 차단하고 고객과 직접 연락하여 거래의 정당성을 확인하는 것이 권장됩니다.",
          },
          9770: {
            summary:
              '이 거래는 <span class="highlight">현금 입금 유형의 의심스러운 패턴</span>으로 인해 사기로 분류되었습니다.',
            keyFactors: [
              "현금 입금 유형(type_CASH_IN)이 가장 큰 영향(+39,461)을 미쳤으며, 이는 사기 거래의 전형적인 특징입니다.",
              "잔액 대비 거래금액의 비정상적 비율(+30,624)은 일반적인 거래 범위를 크게 초과합니다.",
              "송금자 잔액의 급격한 변화(+21,934)는 의심스러운 자금 이동을 시사합니다.",
              "거래 시간대(+14,000)도 의심스러운 패턴을 보여 추가적인 위험 신호를 제공합니다.",
            ],
            recommendation:
              "고객에게 거래의 정당성을 확인하고, 필요시 추가적인 검증 절차를 진행하는 것이 좋겠습니다.",
          },
          9771: {
            summary:
              '이 거래는 <span class="highlight">현금 입금과 잔액 불일치</span>로 인해 사기로 분류되었습니다.',
            keyFactors: [
              "현금 입금 유형(type_CASH_IN)이 주요 영향 요소(+39,464)로 작용했습니다.",
              "잔액 대비 거래금액의 비정상적 비율(+30,702)은 일반적인 거래 패턴과 차이를 보입니다.",
              "송금자 잔액의 변화(+18,160)는 의심스러운 자금 이동을 시사합니다.",
              "거래 시간대(+12,000)도 위험도 평가에 영향을 미쳤습니다.",
            ],
            recommendation:
              "거래의 정당성을 확인하고, 고객의 거래 이력을 점검하는 것이 권장됩니다.",
          },
        };

        const explanation = explanations[transactionId];
        if (explanation) {
          llmExplanation.innerHTML = `
            <div class="llm-explanation-content">
              <p>${explanation.summary}</p>
              
              <p><strong>주요 위험 요소:</strong></p>
              <ul>
                ${explanation.keyFactors
                  .map((factor) => `<li>${factor}</li>`)
                  .join("")}
              </ul>
              
              <p><strong>권장 조치:</strong></p>
              <p>${explanation.recommendation}</p>
            </div>
          `;
        }
      }

      // 보고서 생성
      function generateReport() {
        closeTransactionModal();
        // 새 창에서 보고서 페이지 열기
        window.open("reports.html", "_blank");
      }

      // 정상거래로 변경 함수
      function overrideToNormal() {
        const reason = document.getElementById("overrideReason").value.trim();
        const reviewer = document.getElementById("reviewerName").value.trim();

        // 입력 검증
        if (!reason) {
          alert("정상거래 변경 사유를 입력해주세요.");
          document.getElementById("overrideReason").focus();
          return;
        }

        if (!reviewer) {
          alert("검토자명을 입력해주세요.");
          document.getElementById("reviewerName").focus();
          return;
        }

        // 확인 다이얼로그
        if (
          confirm(
            "정말로 이 거래를 정상거래로 변경하시겠습니까?\n\n변경 사유: " +
              reason +
              "\n검토자: " +
              reviewer
          )
        ) {
          // 정상거래로 변경 처리
          processOverride(reason, reviewer);
        }
      }

      // 정상거래 변경 처리 함수
      function processOverride(reason, reviewer) {
        // 버튼 비활성화
        const overrideBtn = document.querySelector(".btn-override");
        overrideBtn.disabled = true;
        overrideBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> 처리 중...';

        // 실제로는 서버에 변경 요청을 보내야 함
        setTimeout(() => {
          // 성공 메시지 표시
          showOverrideSuccess();

          // 모달 닫기
          setTimeout(() => {
            closeTransactionModal();
          }, 2000);
        }, 1500);
      }

      // 정상거래 변경 성공 메시지 표시
      function showOverrideSuccess() {
        const overrideSection = document.querySelector(".override-section");
        overrideSection.innerHTML = `
          <div style="text-align: center; padding: 30px;">
            <div style="color: #48bb78; font-size: 3rem; margin-bottom: 20px;">
              <i class="fas fa-check-circle"></i>
            </div>
            <h3 style="color: #48bb78; margin-bottom: 15px;">정상거래로 변경 완료!</h3>
            <p style="color: #718096;">
              AI 판단이 성공적으로 재검토되었습니다.<br>
              이 거래는 정상거래로 분류됩니다.
            </p>
          </div>
        `;
      }

      // 모델 예측 결과 분석 차트
      const ctx = document.getElementById("confusionMatrix").getContext("2d");
      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: [
            "정상 거래 정확 탐지",
            "사기 거래 정확 탐지",
            "정상을 사기로 잘못 분류",
            "사기를 놓침",
          ],
          datasets: [
            {
              data: [1267648, 4047, 622, 207],
              backgroundColor: [
                "#48bb78", // 초록색 (정상 거래 정확 탐지)
                "#e53e3e", // 빨간색 (사기 거래 정확 탐지)
                "#ed8936", // 주황색 (정상을 사기로 잘못 분류)
                "#ecc94b", // 노란색 (사기를 놓침)
              ],
              borderWidth: 0,
              hoverOffset: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                  size: 12,
                },
              },
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed / total) * 100).toFixed(
                    1
                  );
                  return `${
                    context.label
                  }: ${context.parsed.toLocaleString()} (${percentage}%)`;
                },
              },
            },
          },
        },
      });

      // 피처 중요도 초기화 함수
      function initializeFeatureList() {
        const featureList = document.getElementById("featureList");
        const allFeatures = [
          {
            name: "type_CASH_IN",
            value: 174645,
            description: "현금 입금 유형",
          },
          {
            name: "amount_to_balance_ratio",
            value: 90060,
            description: "잔액 대비 거래금액 비율",
          },
          { name: "oldbalanceOrg", value: 40125, description: "송금자 잔액" },
          { name: "hour", value: 14000, description: "거래 시간" },
          { name: "amount", value: 12021, description: "거래 금액" },
          { name: "type_TRANSFER", value: 8900, description: "이체 거래 유형" },
          { name: "oldbalanceDest", value: 7500, description: "수신자 잔액" },
          { name: "type_PAYMENT", value: 6800, description: "결제 거래 유형" },
          {
            name: "balance_zero_both",
            value: 5200,
            description: "양쪽 잔액 모두 0",
          },
          { name: "type_DEBIT", value: 4100, description: "직불 거래 유형" },
        ];

        // 처음에는 상위 5개만 표시
        displayFeatures(allFeatures.slice(0, 5));

        // 전체 피처 데이터를 전역 변수로 저장
        window.allFeaturesData = allFeatures;
        window.isFeatureListExpanded = false;
      }

      // 피처 목록 표시 함수
      function displayFeatures(features) {
        const featureList = document.getElementById("featureList");
        featureList.innerHTML = features
          .map(
            (feature) => `
          <div class="feature-item">
            <span class="feature-name">${feature.name}</span>
            <span class="feature-value">${feature.value.toLocaleString()}</span>
          </div>
        `
          )
          .join("");
      }

      // 피처 목록 토글 함수
      function toggleFeatureList() {
        const button = document.getElementById("showMoreFeatures");
        const isExpanded = window.isFeatureListExpanded;

        if (!isExpanded) {
          // 전체 피처 표시
          displayFeatures(window.allFeaturesData);
          button.innerHTML = '<i class="fas fa-chevron-up"></i> 접기';
          button.classList.add("expanded");
          window.isFeatureListExpanded = true;
        } else {
          // 상위 5개만 표시
          displayFeatures(window.allFeaturesData.slice(0, 5));
          button.innerHTML = '<i class="fas fa-chevron-down"></i> 더보기';
          button.classList.remove("expanded");
          window.isFeatureListExpanded = false;
        }
      }

      // 모델 상세 정보 토글 함수
      function toggleModelDetails() {
        const details = document.getElementById("modelDetails");
        const button = document.querySelector(".model-toggle-btn");
        const icon = button.querySelector("i");

        if (details.style.display === "none") {
          details.style.display = "block";
          button.innerHTML =
            '<i class="fas fa-chevron-up"></i> 상세 정보 숨기기';
          button.classList.add("expanded");
        } else {
          details.style.display = "none";
          button.innerHTML =
            '<i class="fas fa-chevron-down"></i> 상세 정보 보기';
          button.classList.remove("expanded");
        }
      }

      // 애니메이션 효과
      document.addEventListener("DOMContentLoaded", function () {
        const cards = document.querySelectorAll(
          ".stat-card, .chart-section, .feature-importance, .shap-analysis"
        );

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.style.opacity = "1";
              entry.target.style.transform = "translateY(0)";
            }
          });
        });

        cards.forEach((card) => {
          card.style.opacity = "0";
          card.style.transform = "translateY(20px)";
          card.style.transition = "opacity 0.6s ease, transform 0.6s ease";
          observer.observe(card);
        });
      });
    </script>
  </body>
</html>
